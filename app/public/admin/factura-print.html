<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Factura - Paints</title>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>
    <div class="factura-print">
        <!-- Botones de acci√≥n (no se imprimen) -->
        <div class="factura-actions no-print">
            <button class="btn btn-primary" onclick="window.print()">
                <i class="bi bi-printer me-2"></i>Imprimir Factura
            </button>
            <button class="btn btn-secondary" onclick="window.close()">
                <i class="bi bi-x-circle me-2"></i>Cerrar
            </button>
        </div>

        <!-- Encabezado -->
        <div class="factura-header">
            <h1>PAINTS E-COMMERCE</h1>
            <p>Sistema de Gesti√≥n de Ventas</p>
            <p><strong>NIT:</strong> 12345678-9</p>
            <p><strong>Direcci√≥n:</strong> Ciudad de Guatemala, Guatemala</p>
            <p><strong>Tel:</strong> (502) 2345-6789</p>
        </div>

        <!-- Informaci√≥n de factura y cliente -->
        <div class="factura-info">
            <div class="factura-info-box">
                <h3>Informaci√≥n de Factura</h3>
                <div class="factura-info-row">
                    <strong>N√∫mero de Factura:</strong>
                    <span id="numeroFactura">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>Fecha de Emisi√≥n:</strong>
                    <span id="fechaEmision">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>Tipo de Venta:</strong>
                    <span id="tipoVenta">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>Sucursal:</strong>
                    <span id="sucursal">-</span>
                </div>
            </div>

            <div class="factura-info-box">
                <h3>Informaci√≥n del Cliente</h3>
                <div class="factura-info-row">
                    <strong>Nombre:</strong>
                    <span id="clienteNombre">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>NIT:</strong>
                    <span id="clienteNit">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>Direcci√≥n:</strong>
                    <span id="clienteDireccion">-</span>
                </div>
                <div class="factura-info-row">
                    <strong>Cajero:</strong>
                    <span id="cajero">-</span>
                </div>
            </div>
        </div>

        <!-- Detalle de productos -->
        <table class="factura-table">
            <thead>
                <tr>
                    <th class="text-center">Cant.</th>
                    <th>Producto</th>
                    <th>SKU</th>
                    <th class="text-right">Precio Unit.</th>
                    <th class="text-right">Subtotal</th>
                </tr>
            </thead>
            <tbody id="detallesBody">
                <!-- Se llena din√°micamente -->
            </tbody>
        </table>

        <!-- Totales -->
        <div class="factura-totales">
            <div class="factura-total-row">
                <strong>Subtotal:</strong>
                <span>Q<span id="subtotal">0.00</span></span>
            </div>
            <div class="factura-total-row">
                <strong>Descuento:</strong>
                <span>Q<span id="descuento">0.00</span></span>
            </div>
            <div class="factura-total-row">
                <strong>IVA (12%):</strong>
                <span>Q<span id="iva">0.00</span></span>
            </div>
            <div class="factura-total-row final">
                <strong>TOTAL A PAGAR:</strong>
                <strong>Q<span id="total">0.00</span></strong>
            </div>
        </div>

        <!-- M√©todos de pago -->
        <div class="factura-info-box" style="margin-top: 30px;">
            <h3>M√©todos de Pago</h3>
            <div id="metodosPago">
                <!-- Se llena din√°micamente -->
            </div>
        </div>

        <!-- Pie de p√°gina -->
        <div class="factura-footer">
            <p><strong>¬°Gracias por su compra!</strong></p>
            <p>Para cualquier consulta o reclamo, presente esta factura</p>
            <p>www.paints.com | info@paints.com</p>
            <p class="no-print" style="margin-top: 20px; font-size: 0.85rem;">
                Documento generado el <span id="fechaImpresion"></span>
            </p>
        </div>
    </div>

    <script src="../js/api.js"></script>
    <script src="../js/utils.js"></script>
    <script>
        async function cargarFactura() {
            const params = new URLSearchParams(window.location.search);
            const numeroFactura = params.get('numero');

            if (!numeroFactura) {
                alert('No se especific√≥ n√∫mero de factura');
                window.close();
                return;
            }

            try {
                const resultado = await obtenerFacturaPorNumero(numeroFactura);

                if (!resultado.success) {
                    throw new Error(resultado.message);
                }

                const factura = resultado.data;

                console.log('üìÑ Factura cargada:', factura); // Debug

                // Informaci√≥n general
                document.getElementById('numeroFactura').textContent = factura.numero_factura;
                document.getElementById('fechaEmision').textContent = formatearFecha(factura.fecha_emision || factura.created_at);
                document.getElementById('tipoVenta').textContent = factura.tipo_venta === 'online' ? 'En L√≠nea' : 'F√≠sica';
                document.getElementById('sucursal').textContent = factura.sucursal?.nombre || 'N/A';

                // Cliente
                document.getElementById('clienteNombre').textContent = factura.cliente_nombre || 'N/A';
                document.getElementById('clienteNit').textContent = factura.cliente_nit || 'CF';
                document.getElementById('clienteDireccion').textContent = factura.cliente_direccion || '-';
                document.getElementById('cajero').textContent = factura.usuario_emite ?
                    `${factura.usuario_emite.nombre} ${factura.usuario_emite.apellido}` : 'N/A';

                // ‚úÖ Convertir a n√∫meros con parseFloat
                const subtotal = parseFloat(factura.subtotal) || 0;
                const descuento = parseFloat(factura.descuento_total) || 0;
                const total = parseFloat(factura.total) || 0;

                // Calcular IVA (el total ya incluye IVA, debemos extraerlo)
                const iva = total - subtotal + descuento;

                // Mostrar totales
                document.getElementById('subtotal').textContent = subtotal.toFixed(2);
                document.getElementById('descuento').textContent = descuento.toFixed(2);
                document.getElementById('iva').textContent = iva.toFixed(2);
                document.getElementById('total').textContent = total.toFixed(2);

                // Detalles
                const tbody = document.getElementById('detallesBody');

                if (!factura.detalles || factura.detalles.length === 0) {
                    tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted">
                            No hay detalles de productos
                        </td>
                    </tr>
                `;
                } else {
                    tbody.innerHTML = factura.detalles.map(detalle => {
                        const cantidad = parseInt(detalle.cantidad) || 0;
                        const precioUnitario = parseFloat(detalle.precio_unitario) || 0;
                        const subtotalItem = parseFloat(detalle.subtotal) || (cantidad * precioUnitario);

                        return `
                        <tr>
                            <td class="text-center">${cantidad}</td>
                            <td>${detalle.producto_nombre || detalle.producto?.nombre || 'N/A'}</td>
                            <td>${detalle.producto_sku || detalle.producto?.sku || '-'}</td>
                            <td class="text-right">Q${precioUnitario.toFixed(2)}</td>
                            <td class="text-right">Q${subtotalItem.toFixed(2)}</td>
                        </tr>
                    `;
                    }).join('');
                }

                // M√©todos de pago
                const metodosPagoDiv = document.getElementById('metodosPago');

                if (!factura.pagos || factura.pagos.length === 0) {
                    metodosPagoDiv.innerHTML = `
                    <div class="factura-info-row">
                        <span class="text-muted">No hay informaci√≥n de m√©todos de pago</span>
                    </div>
                `;
                } else {
                    metodosPagoDiv.innerHTML = factura.pagos.map(pago => {
                        const monto = parseFloat(pago.monto) || 0;
                        const nombreMetodo = pago.metodo_pago?.nombre || 'N/A';

                        return `
                        <div class="factura-info-row">
                            <strong>${nombreMetodo}:</strong>
                            <span>Q${monto.toFixed(2)}</span>
                        </div>
                    `;
                    }).join('');
                }

                // Fecha de impresi√≥n
                document.getElementById('fechaImpresion').textContent = new Date().toLocaleString('es-GT');

            } catch (error) {
                console.error('‚ùå Error:', error);
                alert('Error al cargar la factura: ' + error.message);
            }
        }

        // Cargar al inicio
        cargarFactura();
    </script>

</body>

</html>